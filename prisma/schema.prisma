// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // <--- CETTE LIGNE EST INDISPENSABLE
}

// ============================================
// ENUMS
// ============================================

/**
 * Statut d'une facture
 */
enum InvoiceStatus {
  DRAFT // Brouillon
  SENT // Envoyée
  PAID // Payée
  OVERDUE // En retard
  CANCELLED // Annulée
}

/**
 * Type de transaction (entrée ou sortie d'argent)
 */
enum TransactionType {
  INCOME // Recette
  EXPENSE // Dépense
}

/**
 * Catégorie de transaction pour le classement comptable
 */
enum TransactionCategory {
  TRANSPORT // Transport
  REPAS // Repas
  MATERIEL // Matériel
  PRESTATION // Prestation de service
  IMPOTS // Impôts et taxes
  SALAIRES // Salaires
  AUTRE // Autre
}

/**
 * Statut d'une transaction bancaire
 */
enum TransactionStatus {
  PENDING // En attente
  COMPLETED // Complétée
}

/**
 * Provider d'intégration externe
 */
enum IntegrationProvider {
  STRIPE // Stripe
  PAYPAL // PayPal
}

/**
 * Type de charge indirecte
 */
enum OverheadCategory {
  FIXED // Charge fixe mensuelle (ex: Loyer, Électricité)
  URSSAF_PERCENT // Charge en % du CA (ex: URSSAF)
}

// ============================================
// MODELS
// ============================================

/**
 * Utilisateur (entrepreneur) du système
 * Un utilisateur peut gérer plusieurs entreprises (multi-sociétés)
 */
model User {
  id             String   @id @default(uuid())
  clerkUserId    String   @unique // ID de l'utilisateur dans Clerk (pour la synchronisation)
  email          String   @unique
  name           String?
  passwordHash   String? // Nullable si authentification via provider externe
  authProviderId String? // ID du provider externe (Google, GitHub, etc.)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  companies        Company[]
  assistantThreads AssistantThread[]
  bankAccounts     BankAccount[] // Comptes bancaires connectés via Plaid
  integrations     Integration[] // Intégrations externes (Stripe, PayPal, etc.)
  documents        Document[] // Documents stockés
  folders          Folder[] // Dossiers pour organiser les documents

  @@index([email])
  @@index([clerkUserId]) // Index pour recherche rapide par Clerk ID
  @@map("users")
}

/**
 * Entreprise gérée par l'utilisateur
 * Entité centrale : toutes les factures et transactions sont liées à une Company
 */
model Company {
  id                 String   @id @default(uuid())
  name               String
  siret              String?  @unique // Numéro SIRET (unique par entreprise)
  vatNumber          String? // Numéro de TVA intracommunautaire
  address            String?
  logoUrl            String?
  currency           String   @default("EUR") // Devise par défaut
  legalForm          String? // Forme juridique (ex: "SARL", "Auto-entrepreneur", "EI")
  apeCode            String? // Code APE/NAF (ex: "6201Z")
  capital            String? // Capital social (ex: "1000")
  isAutoEntrepreneur Boolean  @default(false) // Si true, TVA non applicable (art. 293 B du CGI)
  revenueKeywords     String? // Mots-clés séparés par des virgules pour identifier le CA (ex: "STRIPE,VRST,VIR")
  taxRate             Float    @default(22.0) // Pourcentage du CA à mettre de côté pour les taxes (URSSAF/Impôts)
  userId             String // Propriétaire de l'entreprise
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  clients      Client[]
  invoices     Invoice[]
  transactions Transaction[]
  costProfile  CostProfile?
  services     ServiceDefinition[]
  supplies     Supply[]
  equipment    Equipment[]
  overheads    Overhead[]
  serviceRecipes ServiceRecipe[]

  @@index([userId])
  @@index([siret])
  @@map("companies")
}

/**
 * Client de l'entreprise
 * Les factures sont émises pour ces clients
 */
model Client {
  id        String   @id @default(uuid())
  name      String
  email     String?
  phone     String? // Numéro de téléphone du client
  address   String?
  siret     String? // SIRET du client
  vatIntra  String? // Numéro TVA intracommunautaire du client
  companyId String // Entreprise propriétaire
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  company   Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoices  Invoice[]
  documents Document[]

  @@index([companyId])
  @@index([email])
  @@map("clients")
}

/**
 * Facture émise par l'entreprise à un client
 * Contient plusieurs lignes (InvoiceRow) détaillant les prestations
 */
model Invoice {
  id            String        @id @default(uuid())
  number        String // Numéro de facture (ex: INV-001)
  issuedDate    DateTime // Date d'émission
  dueDate       DateTime? // Date d'échéance (optionnelle)
  status        InvoiceStatus @default(DRAFT)
  paymentTerms  String        @default("30 jours") // Conditions de paiement (ex: "30 jours")
  legalMentions String? // Mentions légales spécifiques (optionnel)
  paymentLink   String? // URL vers la page de paiement Stripe
  stripeSessionId String? // ID technique de la session Stripe Checkout
  companyId     String // Entreprise émettrice
  clientId      String // Client destinataire
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  company Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  client  Client       @relation(fields: [clientId], references: [id], onDelete: Restrict)
  rows    InvoiceRow[]

  @@unique([companyId, number]) // Numéro unique par entreprise
  @@index([companyId])
  @@index([clientId])
  @@index([status])
  @@index([number])
  @@map("invoices")
}

/**
 * Ligne de facture détaillant une prestation ou un produit
 * Chaque facture contient une ou plusieurs lignes
 */
model InvoiceRow {
  id          String   @id @default(uuid())
  description String // Description de la prestation/produit
  quantity    Float    @default(1.0) // Quantité
  unitPrice   Decimal  @db.Decimal(10, 2) // Prix unitaire HT
  vatRate     Float    @default(0.0) // Taux de TVA (ex: 20.0 pour 20%)
  invoiceId   String // Facture parente
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_rows")
}

/**
 * Transaction bancaire réelle
 * Gère le flux d'argent réel (entrées et sorties)
 * Base de la comptabilité quotidienne
 */
model Transaction {
  id          String              @id @default(uuid())
  date        DateTime // Date de la transaction
  amount      Decimal             @db.Decimal(10, 2) // Montant (toujours positif)
  description String?
  type        TransactionType // INCOME ou EXPENSE
  category    TransactionCategory // Catégorie comptable
  status      TransactionStatus   @default(PENDING)
  receiptUrl  String? // URL de la photo du ticket (pour OCR futur)
  stripeId    String? @unique // ID de la transaction Stripe (pour dédoublonner)
  companyId   String // Entreprise propriétaire
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([date])
  @@index([type])
  @@index([category])
  @@index([status])
  @@index([stripeId])
  @@map("transactions")
}

/**
 * Thread de conversation avec l'assistant IA (CFO IA)
 * Stocke l'historique des conversations pour le contexte
 */
model AssistantThread {
  id          String   @id @default(uuid())
  userId      String // Utilisateur propriétaire du thread
  userMessage String // Message de l'utilisateur
  aiResponse  String // Réponse de l'IA
  tokensUsed  Int? // Nombre de tokens utilisés (pour tracking coûts)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("assistant_threads")
}

/**
 * Compte bancaire connecté via Plaid
 * Permet la synchronisation automatique des transactions bancaires
 */
model BankAccount {
  id           String    @id @default(uuid())
  userId       String // Propriétaire du compte
  bankName     String // Nom de la banque (ex: "Chase", "Bank of America")
  mask         String? // 4 derniers chiffres du compte (ex: "1234")
  itemId       String    @unique // ID Plaid de l'objet Item
  accessToken  String // Token secret Plaid pour accéder aux données (à chiffrer en production)
  cursor       String? // Curseur pour la pagination des transactions Plaid
  lastSyncedAt DateTime? // Dernière synchronisation des transactions
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([itemId])
  @@map("bank_accounts")
}

/**
 * Intégration avec des services externes (Stripe, PayPal, etc.)
 * Permet la synchronisation automatique des transactions
 */
model Integration {
  id          String              @id @default(uuid())
  userId      String // Utilisateur propriétaire
  provider    IntegrationProvider // STRIPE, PAYPAL, etc.
  apiKey      String // Clé API (à chiffrer en production)
  accountId   String? // ID du compte externe (ex: account ID Stripe)
  lastSyncedAt DateTime? // Dernière synchronisation
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, provider]) // Un seul compte par provider par utilisateur
  @@index([userId])
  @@index([provider])
  @@map("integrations")
}

/**
 * Profil de coûts de l'entreprise
 * Permet de calculer le coût horaire réel en tenant compte des charges fixes, salaire, vacances, etc.
 */
model CostProfile {
  id                  String   @id @default(uuid())
  companyId           String   @unique // Une entreprise a un seul profil de coûts
  monthlyFixedCosts   Float    @default(0) // Total Loyer, Électricité, Assurance, etc. (€/mois)
  desiredMonthlySalary Float    @default(0) // Salaire net visé (€/mois)
  socialChargesRate   Float    @default(22.0) // % de charges sociales (ex: 22% auto-entrepreneur, 45% salarié)
  workingDaysPerMonth Int      @default(20) // Jours travaillés par mois (ex: 20 jours)
  dailyHours          Int      @default(7) // Heures par jour (ex: 7h)
  vacationWeeks       Int      @default(5) // Semaines de congés par an (pour calculer le taux horaire réel)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("cost_profiles")
}

/**
 * Définition d'un service proposé par l'entreprise
 * Permet de calculer le prix de vente en fonction du coût horaire et des matériaux
 */
model ServiceDefinition {
  id             String   @id @default(uuid())
  companyId      String
  name           String // Nom du service (ex: 'Prestation Standard', 'Coupe + Brushing')
  durationMinutes Int      // Temps passé en minutes (ex: 60, 90)
  materialCost   Float    @default(0) // Coût des produits utilisés (shampoing, bois, api...) en €
  platformFees  Float    @default(0) // % de commission plateforme (ex: Booking 15%, Uber 25%)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("service_definitions")
}

/**
 * Consommables (Supplies) - Produits utilisés dans les prestations
 * Ex: Shampooing, Crème, Produits de beauté
 */
model Supply {
  id            String   @id @default(uuid())
  companyId     String
  name          String // Nom du produit (ex: "Shampooing L'Oréal")
  supplier      String? // Fournisseur (ex: "L'Oréal")
  purchasePrice Float    // Prix d'achat total (ex: 20€)
  totalQuantity Float    // Quantité totale (ex: 1000)
  unit          String   @default("ml") // Unité (ex: "ml", "g", "pièce")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  serviceSupplies ServiceSupply[]

  @@index([companyId])
  @@map("supplies")
}

/**
 * Matériel amortissable (Equipment) - Machines et équipements
 * Ex: Lampe UV, Appareil de massage, Sèche-cheveux professionnel
 */
model Equipment {
  id            String   @id @default(uuid())
  companyId     String
  name          String // Nom de l'équipement (ex: "Lampe UV")
  supplier      String? // Fournisseur
  purchasePrice Float    // Prix d'achat (ex: 200€)
  lifespanMonths Int     // Durée de vie en mois (ex: 24 mois)
  weeklyUses    Int      // Nombre d'utilisations par semaine (ex: 20 prestations/semaine)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  serviceEquipment ServiceEquipment[]

  @@index([companyId])
  @@map("equipment")
}

/**
 * Charges Indirectes (Overhead) - Coûts fixes ou variables
 * Ex: Loyer, Électricité, Logiciel, URSSAF
 */
model Overhead {
  id          String           @id @default(uuid())
  companyId   String
  name        String // Nom de la charge (ex: "Loyer", "URSSAF")
  monthlyCost Float  // Coût mensuel (pour FIXED) ou % du CA (pour URSSAF_PERCENT)
  category    OverheadCategory @default(FIXED)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("overheads")
}

/**
 * Recette de Service (ServiceRecipe) - Définition complète d'une prestation
 * Contient les consommables, matériel et temps de main d'œuvre nécessaires
 */
model ServiceRecipe {
  id                String   @id @default(uuid())
  companyId         String
  name              String // Nom du service (ex: "Coupe + Brushing")
  laborTimeMinutes  Int      // Temps de main d'œuvre en minutes
  laborHourlyCost   Float    // Coût horaire de la main d'œuvre (€/h)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  company         Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  suppliesUsed    ServiceSupply[]
  equipmentUsed   ServiceEquipment[]

  @@index([companyId])
  @@map("service_recipes")
}

/**
 * Table de liaison : Consommables utilisés dans une recette de service
 */
model ServiceSupply {
  id              String        @id @default(uuid())
  serviceRecipeId String
  supplyId        String
  quantityUsed    Float         // Quantité utilisée (ex: 5ml de shampooing)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  serviceRecipe ServiceRecipe @relation(fields: [serviceRecipeId], references: [id], onDelete: Cascade)
  supply        Supply        @relation(fields: [supplyId], references: [id], onDelete: Cascade)

  @@unique([serviceRecipeId, supplyId]) // Un consommable ne peut être ajouté qu'une fois par service
  @@index([serviceRecipeId])
  @@index([supplyId])
  @@map("service_supplies")
}

/**
 * Table de liaison : Matériel utilisé dans une recette de service
 */
model ServiceEquipment {
  id              String        @id @default(uuid())
  serviceRecipeId String
  equipmentId     String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  serviceRecipe ServiceRecipe @relation(fields: [serviceRecipeId], references: [id], onDelete: Cascade)
  equipment     Equipment     @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@unique([serviceRecipeId, equipmentId]) // Un équipement ne peut être ajouté qu'une fois par service
  @@index([serviceRecipeId])
  @@index([equipmentId])
  @@map("service_equipment")
}

/**
 * Dossier pour organiser les documents (système hiérarchique)
 * Permet de créer une structure de dossiers et sous-dossiers
 */
model Folder {
  id        String   @id @default(uuid())
  name      String // Nom du dossier
  userId    String // Utilisateur propriétaire
  parentId  String? // Dossier parent (null = racine)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent   Folder?   @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children Folder[]  @relation("FolderHierarchy")
  documents Document[]

  @@index([userId])
  @@index([parentId])
  @@map("folders")
}

/**
 * Document stocké (PDF/Image) avec extraction de texte pour l'IA
 * Permet le stockage et la recherche dans les documents via RAG
 */
model Document {
  id            String    @id @default(uuid())
  userId        String // Utilisateur propriétaire
  clientId      String? // Client associé (optionnel, pour lier un contrat à un client)
  folderId      String? // Dossier contenant le document (null = racine)
  name          String // Nom du fichier
  url           String // URL Supabase Storage
  type          String // 'PDF' ou 'IMAGE'
  extractedText String    @db.Text // Texte extrait du document (pour recherche)
  summary       String? // Résumé généré par l'IA à l'upload
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  client Client?  @relation(fields: [clientId], references: [id], onDelete: SetNull)
  folder Folder?  @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([clientId])
  @@index([folderId])
  @@index([type])
  @@map("documents")
}
